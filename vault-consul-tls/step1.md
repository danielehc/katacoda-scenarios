Consul requires that all clients and servers have key pairs that are generated by a single Certificate Authority. This can be a private CA, used only internally. The CA then signs keys for each of the agents.

In this lab you will use the PKI engine to generate the necessary CA and certificates.

## Generate root CA

Generate the root certificate and save the certificate in `CA_cert.crt`.

`vault write -field=certificate pki/root/generate/internal \
        common_name="dc1.consul" \
        ttl=87600h > CA_cert.crt`{{execute T1}}

This generates a new self-signed CA certificate and private key.
Vault will automatically revoke the generated root at the end of its lease period (TTL);
the CA certificate will sign its own Certificate Revocation List (CRL).

> If you want, you can inspect the certificate created using the `openssl` tool:
> `openssl x509 -text -noout -in CA_cert.crt`{{execute T1}}

Configure the CA and CRL URLs.

`vault write pki/config/urls \
        issuing_certificates="http://127.0.0.1:8200/v1/pki/ca" \
        crl_distribution_points="http://127.0.0.1:8200/v1/pki/crl"`{{execute T1}}

Example output:

```
Success! Data written to: pki/config/urls
```

## Generate intermediate CA

First, enable the `pki` secrets engine at the `pki_int` path.

`vault secrets enable -path=pki_int pki`{{execute T1}}

Example output:

```
Success! Enabled the pki secrets engine at: pki_int/
```

Tune the `pki_int` secrets engine to issue certificates
with a maximum time-to-live (TTL) of 43800 hours.

`vault secrets tune -max-lease-ttl=43800h pki_int`{{execute T1}}

Example output:

```
Success! Tuned the secrets engine at: pki_int/
```

Request an intermediate certificate and save the CSR as `pki_intermediate.csr`.

`vault write -format=json pki_int/intermediate/generate/internal \
        common_name="dc1.consul Intermediate Authority" \
        | jq -r '.data.csr' > pki_intermediate.csr`{{execute T1}}

The command has no output.

### Sign the CSR

`vault write -format=json pki/root/sign-intermediate csr=@pki_intermediate.csr \
        format=pem_bundle ttl="43800h" \
        | jq -r '.data.certificate' > intermediate.cert.pem`{{execute T1}}

The command has no output.

Once the CSR is signed, and the root CA returns a certificate,
it can be imported back into Vault.

`vault write pki_int/intermediate/set-signed certificate=@intermediate.cert.pem`{{execute T1}}

Example output:

```
Success! Data written to: pki_int/intermediate/set-signed
```

## Create a role

A role is a logical name that maps to a policy used to generate credentials.

`vault write pki_int/roles/consul-dc1 \
        allowed_domains="dc1.consul" \
        allow_subdomains=true \
        generate_lease=true \
        max_ttl="720h"`{{execute T1}}

Example output:

```
Success! Data written to: pki_int/roles/consul-dc1
```

For this lab, you are using the following options for the role:

* `allowed_domains` :  Specifies the domains of the role. The command uses `dc1.consul` as the domain, which is the default configuration you are going to use for Consul.
* `allow_subdomains` : Specifies if clients can request certificates with CNs that are subdomains of the CNs allowed by the other role options (NOTE: This includes wildcard subdomains.)
* `generate_lease` :   Specifies if certificates issued/signed against this role will have Vault leases attached to them. Certificates can be added to the CRL by Vault revoke <lease_id> when certificates are associated with leases.

This completes the Vault configuration as a CA.
Move to next step to generate certificates.

<!-- This could go to next step -->

## Generate a server certificate

You can test the `pki` engine is configured correctly by generating your first certificate.

`vault write pki_int/issue/consul-dc1 \
  common_name="server.dc1.consul" \
  ttl="5m" | tee certs.txt`{{execute T1}}

<div style="background-color:#fcf6ea; color:#866d42; border:1px solid #f8ebcf; padding:1em; border-radius:3px; margin:24px 0;">
  <p><strong>Warning:</strong><br>
  
  The TTL for the certificate is being set to 5 minutes in this lab, meaning that this certificate will be valid only for 5 minutes before expiring. This will permit you to test automatic renewal for certificates without having to wait too long. 

</p></div>


Example output:

```
Key                 Value
---                 -----
lease_id            pki_int/issue/consul-dc1/lFfKfpxtM0xY0AHDlr9pJ2GM
lease_duration      23h59m59s
lease_renewable     false
ca_chain            [-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----]
certificate         -----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
expiration          1599645187
issuing_ca          -----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
private_key         -----BEGIN RSA PRIVATE KEY-----
...
-----END RSA PRIVATE KEY-----
private_key_type    rsa
serial_number       3f:ec:bd:ea:01:a6:35:49:a7:6d:17:ba:13:88:c1:b8:35:b4:fc:4c
```

<div style="background-color:#fcf6ea; color:#866d42; border:1px solid #f8ebcf; padding:1em; border-radius:3px;">
  <p><strong>Warning: </strong>
  In this hands-on lab, you are redirecting the output of the `vault write` command to a file to simplify operations in the next steps.
</p></div>